---
title: "04-hmm-3state"
author: "Kaitlyn"
date: "1/21/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Load and clean data

```{r}
library(dplyr)
library(moveHMM)
library(tidyr)
library(ggplot2)
```

Load data & remove outliers.
```{r}
# Load cleaned data
igotu_data <- read.csv("Data/igotu_data_3min_covariates.csv")

# Select columns of interest
igotu_data_fewer <- igotu_data %>% 
    dplyr::select(ID, Party_ID, Longitude, Latitude, DateTime,
                  rugged49.clean, rugged25.clean, rugged9.clean,
                  hq_dist, vegetation.coarser.clean2, view,
                  veg.edges.dist.clean, road.dist.clean,
                  grass_120m, chap_120m, wood_120m)

# prep data for HMM
data_hmm <- moveHMM::prepData(igotu_data_fewer, 
                              type="LL", 
                              coordNames=c("Longitude","Latitude"))

# remove 300 step lengths of 'NA'
data_hmm <- data_hmm %>% 
    drop_na(step) 

# filter out all steps > 15mph
data_hmm <- data_hmm %>% 
    filter(step < 1.207008)
```

Scale covariates.
```{r}
head(data_hmm)
data_hmm$rugged49_scale <- scale(data_hmm$rugged49.clean)
data_hmm$rugged25_scale <- scale(data_hmm$rugged25.clean)
data_hmm$rugged9_scale <- scale(data_hmm$rugged9.clean)
data_hmm$hq_scale <- scale(data_hmm$hq_dist)
data_hmm$view_scale <- scale(data_hmm$view)
data_hmm$vegedge_scale <- scale(data_hmm$veg.edges.dist.clean)
data_hmm$road_scale <- scale(data_hmm$road.dist.clean)
data_hmm$grass_scale <- scale(data_hmm$grass_120m)
data_hmm$chap_scale <- scale(data_hmm$chap_120m)
data_hmm$wood_scale <- scale(data_hmm$wood_120m)
head(data_hmm)
```

Explore correlation between covariates.
```{r}
covariates <- dplyr::select(data_hmm, rugged49_scale, rugged25_scale, rugged9_scale,
                     hq_scale, view_scale, vegedge_scale, road_scale, grass_scale,
                     chap_scale, wood_scale)
round(cor(covariates), digits = 2)
```

There is high correlation between:
0.79 = rugged25_scale and rugged49_scale
0.74 = rugged25_scale and rugged9_scale
-0.77 = grass_scale and wood_scale


# THREE STATE MODELS

Determined the initial values from the exploration in 04b-hmm-3state-parameter-select.Rmd
 
```{r}
mu0_3state <- c(0.07, 0.41, 0.01)
sigma0_3state <- c(0.045, 0.204, 0.010)
zeromass0_3state <- c(0.047, 0.0028, 0.469) 
stepPar0_3state <- c(mu0_3state,sigma0_3state,zeromass0_3state)
angleMean0_3state <- c(0,0,pi)
kappa0_3state <- c(1.20,1.14,0.61)
anglePar0_3state <- c(angleMean0_3state,kappa0_3state)
```

### Null model
```{r}
model0 <- fitHMM(data=data_hmm, nbStates=3, 
             stepPar0=stepPar0_3state, anglePar0=anglePar0_3state)
 
states <- viterbi(model0)
states
 
# proportion of time spent in each state
prop.table(table(states)) 
 
plot(model0)
AIC(model0) # 89677.39
```

## Univariate models
 
### Ruggedness
```{r}
model1 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~rugged25_scale)
model1 # model summary
AIC(model1) # AIC = 89413.5

model2 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~rugged49_scale)
model2 # model summary
AIC(model2) # AIC = 

model3 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~rugged9_scale)
model3 # model summary
AIC(model3) # AIC =  - best with rugged9
```

### Viewshed
```{r}
model4 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~view)
model4 # model summary
AIC(model4) # AIC = 
```

### Distance to road
```{r}
model5 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean)
model5 # model summary
AIC(model5) # AIC = 
```

### Woodland within 120 meters
```{r}
model6 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~wood_120m)
model6 # model summary
AIC(model6) # AIC = 
```

### Chaparral within 120 meters
```{r}
model7 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~chap_120m)
model7 # model summary
AIC(model7) # AIC = 
```

### Grassland within 120 meters
```{r}
model8 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~grass_120m)
model8 # model summary
AIC(model8) # AIC = 
```

### Distance to vegetation type boundary
```{r}
model9 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~veg.edges.dist.clean)
model9 # model summary
AIC(model9) # AIC = 104166.7
```

### Distance to headquarters
```{r}
model10 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~hq_dist)
model10 # model summary
AIC(model10) # AIC = 104948
```


## Two-variable models

### Distance to road + Ruggedness
```{r}
model2.1 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean + rugged9_scale)
model2.1 # model summary
AIC(model2.1) # AIC = 
```

### Distance to road + Chaparral
```{r}
model2.2 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean + chap_scale)
model2.2 # model summary
AIC(model2.2) # AIC = 
```

### Distance to road + Grassland
```{r}
model2.3 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean + grass_scale)
model2.3 # model summary
AIC(model2.3) # AIC = 
```

### Distance to road + Woodland
```{r}
model2.4 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean + wood_scale)
model2.4 # model summary
AIC(model2.4) # AIC = 
```

### Distance to road + Viewshed
```{r}
model2.5 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean + view_scale)
model2.5 # model summary
AIC(model2.5) # AIC = 
```

### Distance to road + Distance to HQ
```{r}
model2.6 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean + hq_scale)
model2.6 # model summary
AIC(model2.6) # AIC = 
```

### Distance to road + Distance to vegetation edge
```{r}
model2.7 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar0_3state, anglePar0=anglePar0_3state,
                 formula = ~road.dist.clean + vegedge_scale)
model2.7 # model summary
AIC(model2.7) # AIC = 
```


## THREE-VARIABLE MODELS
```{r}

```

