---
title: "State Space Models (HMM)"
author: "Kaitlyn"
date: "8/21/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Load and clean data

```{r}
library(dplyr)
library(moveHMM)
library(tidyr)
library(ggplot2)
```

Load data.
```{r}
# Load cleaned data
igotu_data <- read.csv("Data/igotu_data_3min_covariates.csv")

# Select columns of interest
igotu_data_fewer <- igotu_data %>% 
    dplyr::select(ID, Longitude, Latitude, DateTime,
                  rugged49.clean, rugged25.clean, rugged9.clean,
                  hq_dist, vegetation.coarser.clean2, view,
                  veg.edges.dist.clean,
                  grass_120m, chap_120m, wood_120m)

# prep data for HMM
data_hmm <- moveHMM::prepData(igotu_data_fewer, 
                              type="LL", 
                              coordNames=c("Longitude","Latitude"))

# remove 300 step lengths of 'NA'
data_hmm <- data_hmm %>% 
    drop_na(step) 

# filter out all steps > 15mph
data_hmm <- data_hmm %>% 
    filter(step < 1.207008)
```

Look at step lengths and turn angles.
```{r}
hist(data_hmm$step)
hist(data_hmm$angle)

# determine proportion of step lengths equal to 0
whichzero <- which(data_hmm$step == 0)
length(whichzero)/nrow(data_hmm)
```

Ruggedness - need to try a few different resolutions (9, 25, 49) - can do AIC-based model selection to identify best ruggedness value
Viewshed
Distance to road - should predict when they switch from walking to driving
Vegetation type
Area of chaparral within 120 meters
Distance to vegetation type boundary
Distance to headquarters - would expect them to move from driving --> stopping


# TWO STATE MODEL

Create a simple model with two states. Determine initial parameters for mu0 and sigma0 based on observation of histograms.
```{r}
mu0 <- c(0.01, 0.5) # step mean (two parameters: one for each state)
sigma0 <- c(0.01, 0.5) # step SD
zeromass0 <- c(0.50, 0.10) # step zero-mass
stepPar0 <- c(mu0,sigma0,zeromass0)

angleMean0 <- c(pi,0) # angle mean
kappa0 <- c(1,1) # angle concentration
anglePar0 <- c(angleMean0,kappa0)

m <- fitHMM(data=data_hmm, 
            nbStates=2, 
            stepPar0=stepPar0, 
            anglePar0=anglePar0,
            formula = ~view)

m

plot(m)

# proportion of time spent in each state
states <- viterbi(m)
prop.table(table(states)) 

# plot states for a given individual
plotStates(m, animals="080815_01")

plotStates(m)
```

#### Three state model
```{r}
# initial parameters
mu0 <- c(0.01, 0.5, 1.0)
sigma0 <- c(0.01, 0.5, 1.0)
zeromass0 <- c(0.40, 0.40, 0.10)
stepPar3 <- c(mu0,sigma0,zeromass0)

angleMean0 <- c(pi,pi,0)
kappa0 <- c(1,1,1)
anglePar3 <- c(angleMean0,kappa0)

m3 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar3, anglePar0=anglePar3)

states <- viterbi(m3)
states

# proportion of time spent in each state
prop.table(table(states)) 

plot(m3)
  
AIC(m, m3)
```
