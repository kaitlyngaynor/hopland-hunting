---
title: "State Space Models (HMM)"
author: "Kaitlyn"
date: "8/21/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Explore Hidden Markov Models for Hopland hunter data

```{r}
library(moveHMM)
library(dplyr)
```


Load cleaned data.
```{r}
data_hmm <- read.csv("Data/igotu_data_3min_covariates_for_hmm.csv") %>% 
  moveHMM::prepData(type="LL", coordNames=c("x","y"))
```

Look at step lengths and turn angles.
```{r}
hist(data_hmm$step)
hist(data_hmm$angle)
```


Create a simple model with two states. Determine initial parameters for mu0 and sigma0 based on observation of histograms.

# TWO STATE MODEL
```{r}
mu0 <- c(0.01, 0.5) # step mean (two parameters: one for each state)
sigma0 <- c(0.01, 0.5) # step SD
zeromass0 <- c(0.50, 0.10) # step zero-mass
stepPar0 <- c(mu0,sigma0,zeromass0)

angleMean0 <- c(pi,0) # angle mean
kappa0 <- c(1,1) # angle concentration
anglePar0 <- c(angleMean0,kappa0)

m <- fitHMM(data=data_hmm, 
            nbStates=2, 
            stepPar0=stepPar0, 
            anglePar0=anglePar0,
            formula = ~view)

m

plot(m)

# proportion of time spent in each state
states <- viterbi(m)
prop.table(table(states)) 

# plot states for a given individual
plotStates(m, animals="080815_01")

plotStates(m)
```

Now try separating successful vs unsuccessful hunters
```{r}
successful <- igotu_data %>% 
  filter(Harvest == "Y") %>% 
  dplyr::select(ID, lon, lat, rugged49.clean, slope, hq_dist, vegetation.coarser.clean2, view)
unsuccessful <- igotu_data %>% 
  filter(Harvest == "N") %>% 
  dplyr::select(ID, lon, lat, rugged49.clean, slope, hq_dist, vegetation.coarser.clean2, view)

data.successful <- moveHMM::prepData(successful, type="LL", coordNames=c("lon","lat"))
data.unsuccessful <- moveHMM::prepData(unsuccessful, type="LL", coordNames=c("lon","lat"))

hist(data.successful$step, col= 'red', breaks = 50, freq = F); hist(data.unsuccessful$step, col = 'blue', add=T, breaks = 50, freq = F)

hist(data.successful$angle, col= 'red', breaks = 50, freq = F); hist(data.unsuccessful$angle, col = 'blue', add=T, breaks = 50, freq = F)
```

#### Successful vs unsuccessful hunters model

With no transition probabilities
```{r}
m.successful <- fitHMM(data=data.successful, 
            nbStates=2, 
            stepPar0=stepPar0, 
            anglePar0=anglePar0)

m.successful
plot(m.successful)

m.unsuccessful <- fitHMM(data=data.unsuccessful, 
            nbStates=2, 
            stepPar0=stepPar0, 
            anglePar0=anglePar0)

m.unsuccessful
plot(m.unsuccessful)

```



#### Three state model
```{r}
# initial parameters
mu0 <- c(0.01, 0.5, 1.0)
sigma0 <- c(0.01, 0.5, 1.0)
zeromass0 <- c(0.40, 0.40, 0.10)
stepPar3 <- c(mu0,sigma0,zeromass0)

angleMean0 <- c(pi,pi,0)
kappa0 <- c(1,1,1)
anglePar3 <- c(angleMean0,kappa0)

m3 <- fitHMM(data=data_hmm, nbStates=3, stepPar0=stepPar3, anglePar0=anglePar3)

states <- viterbi(m3)
states

# proportion of time spent in each state
prop.table(table(states)) 

plot(m3)
  
AIC(m, m3)
```
