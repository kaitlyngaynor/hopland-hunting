---
title: "Clean up igotu data"
author: "Kaitlyn"
date: "8/24/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(here)
library(dplyr)
library(rgdal)
library(raster)
library(tidyr)
library(adehabitatLT)
library(hms)
library(amt)
library(stringr)
```


### Import and clean tracks

Bring in tracks
```{r}
# import all data and join into single dataframe
igotu_file_names <- list.files(path = "Data/Hunting/igotu_raw/",
                               pattern = "*.csv", full.names = TRUE, recursive = TRUE) 

# read all individual csvs into a list
igotu_raw_dfs <- lapply(igotu_file_names, read.csv) 

# make the file names into the object names in the list
names(igotu_raw_dfs) <- igotu_file_names

# combine all collar files into one dataframe
igotu_raw <- bind_rows(igotu_raw_dfs, .id = "FileName")

# clean columns
igotu_data_all <- igotu_raw %>% 
  mutate(DateTime = as.POSIXct(paste(Date, Time, sep = ""), 
                                    "%m/%d/%y %H:%M:%S",
                                    tz = "America/Los_Angeles"),
         ID = str_replace(FileName, "Data/Hunting/igotu_raw//", ""),
         ID = str_replace(ID, ".csv", "")) %>% 
  select(-c(FileName, Altitude, Speed, Distance, Essential, Track, Course, Type))

# add the metadata
metadata <- read.csv(here::here("Data/Hunting/igotu_metadata_times_cleaned.csv")) %>% 
  mutate(Start_time = paste0(Start_time, ":00"),
         End_time = paste0(End_time, ":00")) %>% 
  select(-Date)
igotu_data_all <- left_join(igotu_data_all, metadata)

# format time
igotu_data_all$Time <- format(igotu_data_all$DateTime, format = "%H:%M:%S")
```

Remove points before start or after end
```{r}
# error in line 784023
igotu_data_all$Keep <- "NO"
for(i in 1:length(unique(igotu_data_all$ID)))
for(i in 1:nrow(igotu_data_all)) {
  if(as_hms(igotu_data_all$Time[i]) > as_hms(igotu_data_all$Start_time[i]) &&
     as_hms(igotu_data_all$Time[i]) < as_hms(igotu_data_all$End_time[i])) {
    igotu_data_all$Keep[i] <- "YES"
  }
}

igotu_data_cropped <- igotu_data_all %>% 
  filter(Keep == "YES")

write.csv(igotu_data_cropped, "Data/igotu_data_cropped.csv", row.names = F)
```


Subsample to 1 minute
```{r}
hunter_tracks <- mk_track(tbl = igotu_data_cropped, 
                              .x = lon, .y = lat,
                              id = ID, 
                              .t = date_time,
                              crs = CRS("+proj=longlat +ellps=WGS84")) 

hunter_resampled <- hunter_tracks %>%
  nest(data = -"id") %>%
  mutate(resampled_data = map(data, function(x)
    x %>% track_resample(rate = minutes(3),
                         tolerance = seconds(0)))) %>%
  select(id, resampled_data) %>%
  unnest(cols = resampled_data) %>%
  rename(
    lon = x_,
    lat = y_,
    date_time = t_,
    ID = id
  )

igotu_data_1min <- left_join(hunter_resampled, igotu_data_cropped) 

write.csv(igotu_data_1min, "Data/igotu_data_1min.csv", row.names=F)
```
