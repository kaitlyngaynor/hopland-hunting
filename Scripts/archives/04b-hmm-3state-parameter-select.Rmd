---
title: "04b-hmm-3state-parameter-select"
author: "Kaitlyn"
date: "1/20/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

Select the starting parameters for the 3-state HMM, as outlined here:
https://cran.r-project.org/web/packages/moveHMM/vignettes/moveHMM-starting-values.pdf

## Load and clean data

```{r}
library(dplyr)
library(moveHMM)
library(tidyr)
library(ggplot2)
```

Load data & remove outliers.
```{r}
# Load cleaned data
igotu_data <- vroom::vroom("Data/igotu_data_3min_covariates.csv")

# Prep data for HMM
data_hmm <- moveHMM::prepData(igotu_data, 
                              type="LL", 
                              coordNames=c("Longitude","Latitude"))

# Filter out all NA steps & steps > 15mph
data_hmm <- data_hmm %>% 
    tidyr::drop_na(step) %>% 
    filter(step < 1.207008)

# Scale covariates
data_hmm$Ruggedness_scale <- scale(data_hmm$Ruggedness)
data_hmm$Viewshed_scale <- scale(data_hmm$Viewshed)
data_hmm$Road_Distance_scale <- scale(data_hmm$Road_Distance)
data_hmm$Chaparral_120m_scale <- scale(data_hmm$Chaparral_120m)
data_hmm$Woodland_120m_scale <- scale(data_hmm$Woodland_120m)
data_hmm$Sunrise_Scale <- scale(data_hmm$Elapsed_Time_Sunrise)
```

Look at step lengths and turn angles.
```{r}
hist(data_hmm$step)
hist(data_hmm$angle)

# determine proportion of step lengths equal to 0
whichzero <- which(data_hmm$step == 0)
length(whichzero)/nrow(data_hmm)
```



## Explore models
```{r}
# Package for parallel computations
library(parallel)
# Create cluster of size ncores
ncores <- detectCores() - 1
cl <- makeCluster(getOption("cl.cores", ncores))

# Export objects needed in parallelised function to cluster 
clusterExport(cl, list("data_hmm", "fitHMM"))

# Number of tries with different starting values
niter <- 100
# Create list of starting values
allPar0 <- lapply(as.list(1:niter), function(x) { 
    # Step length mean
    stepMean0 <- runif(3, min = c(0.0001, 0.05, 0.3), max = c(0.05, 0.3, 1.4))
    # Step length standard deviation
    stepSD0 <- runif(3, min = c(0.0001, 0.05, 0.3), max = c(0.05, 0.3, 1.4))
    # Step length zero mass
    stepZeromass0 <- runif(3, min = 0, max = 1)
    # Turning angle mean
    angleMean0 <- c(0, 0, 0)
    # Turning angle concentration
    angleCon0 <- runif(3, min = c(0.1, 0.5, 1), max = c(0.5, 1, 5))
    # Return vectors of starting values
    stepPar0 <- c(stepMean0, stepSD0, stepZeromass0)
    anglePar0 <- c(angleMean0, angleCon0)
    
    return(list(step = stepPar0, angle = anglePar0))
})
# Fit the niter models in parallel
allm_parallel <- parLapply(cl = cl, X = allPar0, fun = function(par0) { m <- fitHMM(data = data_hmm, nbStates = 3, stepPar0 = par0$step, anglePar0 = par0$angle, formula = ~Road_Distance_scale + Viewshed_scale + Woodland_120m_scale + Ruggedness_scale + Chaparral_120m_scale + Elapsed_Time_Sunrise)
return(m) })

# Extract likelihoods of fitted models
allnllk <- unlist(lapply(allm_parallel, function(m) m$mod$minimum))
allnllk
```

The model converged on the same ending parameter values in 68 of the 100 iterations, indicating numerical stability (-ish). 

```{r}
# Index of best fitting model (smallest negative log-likelihood)
whichbest <- which.min(allnllk)
# Best fitting model
mbest <- allm_parallel[[whichbest]]
mbest
plot(mbest)

# export data
saveRDS(allm_parallel, "Data/3state_parallel_parameter_selection.rds")
```

This best model was as follows:

Value of the maximum log-likelihood: -5327.773 

Step length parameters:
----------------------
             state 1    state 2    state 3
mean      0.01525112 0.39340898 0.02443258
sd        0.01093145 0.27333218 0.01528372
zero-mass 0.06274960 0.01092848 0.81563113

Turning angle parameters:
------------------------
                state 1     state 2  state 3
mean          3.0970339 -2.74690459 2.989487
concentration 0.5451941  0.03521548 1.299684

Regression coeffs for the transition probabilities:
--------------------------------------------------
             1 -> 2    1 -> 3    2 -> 1    2 -> 3    3 -> 1    3 -> 2
intercept -1.916278 -2.934107 -1.950173 -2.864647 -3.112353 -2.341268

Transition probability matrix:
-----------------------------
           [,1]       [,2]       [,3]
[1,] 0.83310300 0.12259411 0.04430289
[2,] 0.11861503 0.83385265 0.04753232
[3,] 0.03900768 0.08433893 0.87665339

Initial distribution:
--------------------
[1] 0.3475458 0.3781836 0.2742707